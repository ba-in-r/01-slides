---
title: "Unidad 10 ‚Äî Detecci√≥n de Anomal√≠as"
subtitle: "Semana 15: Outliers y Ley de Benford"
author: "Eduard F. Mart√≠nez Gonz√°lez"
---

<a href="mailto:efmartinez@icesi.edu.co" style="color:black;">
<img src="pic/correo.png" alt="Email" width="20" height="20"/> efmartinez@icesi.edu.co
</a>

<a href="https://github.com/eduard-martinez" style="color:black;"> 
<img src="pic/github.png" alt="Qries" width="20" height="20"/> eduard-martinez
</a>

<a href="https://twitter.com/emartigo" style="color:black;"> 
<img src="pic/twitter.jpg" alt="Qries" width="20" height="20"/> @emartigo
</a>

<a href="https://eduard-martinez.github.io" style="color:black;"> 
<img src="pic/link.png" alt="Qries" width="20" height="20"/> https://eduard-martinez.github.io
</a>

# ¬øQu√© es una anomal√≠a?

En an√°lisis de datos, una **anomal√≠a** (o *outlier*) es una observaci√≥n que se aleja significativamente del patr√≥n general del conjunto de datos. Detectar estas observaciones es clave, porque pueden revelar errores de registro, fen√≥menos raros o incluso fraudes.

Ejemplos t√≠picos:

- Un cliente con un cr√©dito inusualmente alto.  
- Un estudiante con una calificaci√≥n fuera del rango esperado.  
- Una transacci√≥n con un valor que no se ajusta al comportamiento habitual.

En Business Analytics, la detecci√≥n de anomal√≠as es un paso esencial del an√°lisis exploratorio de datos (EDA) y una herramienta fundamental para la gesti√≥n del riesgo y la auditor√≠a de datos.

## Tipos de anomal√≠as

1. **Univariadas:** afectan a una sola variable (por ejemplo, edad, monto, ingreso).  
2. **Multivariadas:** surgen de combinaciones inusuales entre variables (por ejemplo, clientes j√≥venes con cr√©ditos alt√≠simos).

En esta clase nos centraremos en las anomal√≠as univariadas, aquellas que pueden identificarse analizando cada variable individualmente.

# Aplicaci√≥n en R

En este ejercicio aplicaremos t√©cnicas de detecci√≥n de anomal√≠as sobre una base de datos que simula el comportamiento acad√©mico de un grupo de estudiantes. Cada observaci√≥n representa a un estudiante inscrito en un curso, e incluye variables relacionadas con su desempe√±o y participaci√≥n a lo largo del semestre.

En este contexto:

- Cada **estudiante** es una observaci√≥n.  
- Las **variables num√©ricas** incluyen indicadores como asistencia, participaci√≥n, trabajos, quizzes y proyecto final.  
- El **promedio final** refleja el desempe√±o global del estudiante.  
- Algunas observaciones presentan **valores at√≠picos o inconsistentes**, como notas negativas, valores mayores a 5 o combinaciones poco realistas (por ejemplo, alta asistencia pero promedio bajo).

El objetivo es aplicar un **an√°lisis exploratorio y estad√≠stico** que nos permita:

- Identificar visual y num√©ricamente **valores extremos**.  
- Comparar diferentes **m√©todos de detecci√≥n de outliers** (gr√°ficos, robustos y estad√≠sticos).  
- Reflexionar sobre c√≥mo estas anomal√≠as pueden afectar la interpretaci√≥n y calidad de los datos acad√©micos.

::: callout-tip
Este ejercicio replica una situaci√≥n real en la que un profesor detecta irregularidades en las calificaciones de su grupo.  
A partir de las herramientas estad√≠sticas vistas en clase, aprenderemos c√≥mo diagnosticar y documentar esos casos de manera objetiva.
:::

## Preparaci√≥n del entorno

Antes de comenzar, es importante asegurar que el entorno de trabajo est√© limpio, reproducible y con todas las librer√≠as necesarias cargadas.

1. **Limpiamos** el entorno para evitar conflictos con objetos previos.  
2. **Instalamos** (si es necesario) y **cargamos** los paquetes requeridos para la manipulaci√≥n, visualizaci√≥n y detecci√≥n de anomal√≠as.  
3. **Importamos** la base de datos simulada de notas estudiantiles, que contiene observaciones normales y algunas ‚Äúnotas raras‚Äù generadas intencionalmente.  
4. Exploramos la estructura y primeras filas de la base para familiarizarnos con su contenido.

```{webr-r}
## Limpiar el entorno de trabajo
rm(list = ls())

## Instalar paquetes (solo si es necesario)
if (!require("pacman")) {install.packages("pacman") ; require("pacman")}

## Cargar librer√≠as
p_load(tidyverse) # Manipulaci√≥n y visualizaci√≥n de datos
p_load(outliers)  # Pruebas Grubbs y Dixon
p_load(EnvStats)  # Test de Rosner
p_load(univOutl)  # Funciones integradas para IQR/MAD

## Fijar semilla para reproducibilidad
set.seed(123)
```

::: callout-note
**Descripci√≥n de los paquetes utilizados:**
`tidyverse`: Conjunto de paquetes dise√±ados para la manipulaci√≥n, transformaci√≥n y visualizaci√≥n de datos en R.  

`outliers`: Implementa pruebas estad√≠sticas cl√°sicas para detecci√≥n de valores at√≠picos, como *Grubbs* y *Dixon*, que permiten identificar observaciones extremas en una sola variable num√©rica.

`EnvStats`: Proporciona m√©todos avanzados de an√°lisis estad√≠stico, incluyendo la prueba de Rosner, ideal para detectar *m√∫ltiples outliers simult√°neamente* en una muestra grande.

`univOutl`: Ofrece funciones integradas para aplicar distintos m√©todos robustos de detecci√≥n de outliers univariados, como el *IQR*, *MAD* o *boxplots ajustados* (`LocScaleB`, `boxB`), facilitando la comparaci√≥n entre t√©cnicas.
:::

## Ingesta de datos 

En esta secci√≥n realizamos la ingesta de datos. En este caso, trabajaremos con una base sint√©tica llamada **`notas`**, que representa el rendimiento acad√©mico de un grupo de estudiantes a lo largo del semestre. Cada registro corresponde a un estudiante e incluye variables relacionadas con su desempe√±o, participaci√≥n y h√°bitos de estudio. Algunos registros fueron generados con valores an√≥malos intencionalmente (notas imposibles, inconsistencias o valores fuera de rango), con el fin de practicar su identificaci√≥n.

La estructura de las variables es la siguiente:

- **`asistencia`** ‚Üí proporci√≥n de clases asistidas (0‚Äì1).  
- **`participacion`** ‚Üí nivel de participaci√≥n en clase (0‚Äì5).  
- **`trabajos`** ‚Üí promedio de calificaciones en trabajos entregados (0‚Äì5).  
- **`quiz_1`, `quiz_2`** ‚Üí notas obtenidas en los dos quizzes del curso (0‚Äì5).  
- **`proyecto_final`** ‚Üí nota final del proyecto (0‚Äì5).  
- **`promedio`** ‚Üí calificaci√≥n global del estudiante (ponderaci√≥n de los componentes anteriores).  
- **`grupo`** ‚Üí d√≠a o cohorte al que pertenece el estudiante (por ejemplo, ‚ÄúViernes‚Äù o ‚ÄúMartes‚Äù).  
- **`id_estudiante`** ‚Üí identificador √∫nico de cada estudiante.

Nuestro objetivo ser√° **identificar observaciones que se desv√≠en del patr√≥n general**, como: notas fuera del rango esperado (menores que 0 o mayores que 5); comportamientos incoherentes (alta asistencia con bajo promedio); casos extremos que podr√≠an reflejar errores de registro o comportamientos at√≠picos reales.

```{webr-r}
#| warning: false
#| message: false

## generar los datos
source("https://raw.githubusercontent.com/ba-in-r/01-slides/main/week-15/data/week-15.r")

## check data
print("listo")
```

## Exploratory Data Analysis (EDA)

Antes de aplicar pruebas estad√≠sticas, el primer paso es **visualizar** y **resumir** los datos.  Esto nos permite entender la distribuci√≥n de una variable y detectar visualmente valores at√≠picos. **Objetivos del EDA:**

- Explorar la forma de la distribuci√≥n.  
- Identificar asimetr√≠as, colas largas o valores extremos.  
- Calcular estad√≠sticas descriptivas b√°sicas: Medidas de tendencia central (media, mediana); Medidas de dispersi√≥n (rango, desviaci√≥n est√°ndar, IQR); Medidas de forma (asimetr√≠a y curtosis).

```{webr-r}
## Vista previa
glimpse(notas)
summary(notas)
```

### Visualizaci√≥n de anomal√≠as

El an√°lisis gr√°fico es el punto de partida. Para empezar, utilizaremos histogramas y boxplots que nos ayuden a visualizar la dispersi√≥n de las notas y detectar gr√°ficamente los posibles valores at√≠picos.

```{webr-r}
# Histograma del promedio final
ggplot(notas, aes(x = promedio)) +
geom_histogram(bins = 15, fill = "steelblue", color = "black", alpha = 0.7) +
theme_bw()
```


```{webr-r}
# Boxplot general de notas
ggplot(notas, aes(y = promedio)) +
geom_boxplot(fill = "purple", color = "black", alpha = 0.5, outlier.color = "red") +
theme_bw()
```
  
  
  





## M√©todos de detecci√≥n
Aplica e interpreta:
	‚Ä¢	Percentiles (p. ej. 1% y 99%)
	‚Ä¢	Z-Score (|Z| > 3)
	‚Ä¢	Rango intercuart√≠lico (IQR)
	‚Ä¢	MAD / Hampel
	‚Ä¢	RRMS (varianza robusta)

## Pruebas estad√≠sticas
	‚Ä¢	Grubbs test: un outlier.
	‚Ä¢	Dixon test: muestra peque√±a.
	‚Ä¢	Rosner test: m√∫ltiples outliers.
Explica las hip√≥tesis y el sentido del p-value.

## Verificaci√≥n de normalidad
	‚Ä¢	Usa Q-Q plots (qqplotr).
	‚Ä¢	Explica por qu√© es necesario para algunas pruebas.
	‚Ä¢	Compara distribuciones normales vs. no normales.

## Ley de Benford
	‚Ä¢	Introduce el concepto del primer d√≠gito.
	‚Ä¢	Verifica condiciones: variable num√©rica positiva, sin l√≠mites, con magnitud amplia.
	‚Ä¢	Calcula OOM y ROM.
	‚Ä¢	Aplica benford() y grafica resultados.
	‚Ä¢	Revisa suspectsTable() y duplicatesTable().
	‚Ä¢	Discute implicaciones en auditor√≠a.

# Actividad en clase

	‚Ä¢	En grupos, aplicar tres m√©todos de detecci√≥n a una variable.
	‚Ä¢	Comparar resultados y discutir cu√°l m√©todo es m√°s confiable.
	‚Ä¢	Relacionar resultados con casos reales (fraude, errores de captura, comportamiento an√≥malo).

## Instrucciones:

1. Ejecute los *chunks* de c√≥digo proporcionados en R (puede hacerlo directamente en el navegador o en RStudio).  
2. Observe los resultados obtenidos en cada secci√≥n.  
3. Genere un documento en **Word (.docx)** donde:  
   - Copie las preguntas que aparecen al final.  
   - Redacte sus interpretaciones y conclusiones con base en los resultados.  
   - **No copie el c√≥digo**, solo redacte sus respuestas.  
4. Suba su documento y su **script en R** a la plataforma **Intu**, en la actividad correspondiente a la **Semana 14 ‚Äî Modelo kNN (Predicci√≥n de Retiro)**.

## Estimaci√≥n del modelo kNN

Ejecute el siguiente c√≥digo para estimar un modelo **k-Nearest Neighbors (kNN)** que prediga la **probabilidad de que un estudiante se retire del curso**, usando las variables explicativas relacionadas con esfuerzo y participaci√≥n.  ‚ö†Ô∏è No incluya la variable `aprueba` en el modelo.

```{webr-r}
##==: 1. Preparar Entorno

## Limpiar el entorno de trabajo
rm(list = ls())

## Instalar paquetes (solo si es necesario)
if (!require("pacman")) {install.packages("pacman") ; require("pacman")}

## Cargar librer√≠as
p_load(tidyverse)  # Manipulaci√≥n y visualizaci√≥n de datos
p_load(class)      # Implementaci√≥n del algoritmo kNN
p_load(caret)      # M√©tricas y matriz de confusi√≥n
p_load(pROC)       # Calcular la curva ROC y el AUC

##==: 2. Ingesta de Datos

## Leer datos
source("https://raw.githubusercontent.com/ba-in-r/01-slides/main/week-13/data/week-13.r")

## Preparar los datos
vars <- select(datos, horas_estudio:afinidad_estadistica)
datos_scaled <- as.data.frame(scale(vars))
datos_scaled$retira <- factor(datos$retira, levels = c(0, 1), labels = c("No", "S√≠"))

## Ver datos 
head(datos_scaled)
``` 

## Preguntas para el informe

**1. Comparaci√≥n entre modelos:**

‚Ä¢	¬øC√≥mo cambia la matriz de confusi√≥n al pasar de k = 5 a k = 10 y k = 20?

**2. Evaluaci√≥n de desempe√±o:**

‚Ä¢	Calcule la exactitud (accuracy) para cada modelo (k = 5, k = 10, k = 20).

‚Ä¢	¬øCu√°l de los tres modelos presenta la mayor exactitud?

**3. Curva ROC y poder discriminatorio**

‚Ä¢	¬øQu√© valor de AUC obtuvo para k = 5?

‚Ä¢	¬øQu√© indica este valor sobre la capacidad del modelo para distinguir entre estudiantes que se retiran y los que no?

‚Ä¢	¬øEsperar√≠as que el AUC mejore, empeore o se mantenga al aumentar k? ¬øPor qu√©?

**4. Reflexi√≥n final:** Si tuvieras que elegir uno de los tres modelos, ¬øcu√°l seleccionar√≠as y por qu√©?

::: callout-tip
üí° Entrega: Suba su documento con las respuestas a la plataforma Intu, en la actividad correspondiente a la Semana 14 ‚Äî Modelo kNN (Predicci√≥n de Retiro). Y suba el script con el que realiz√≥ el procedimiento. Recuerde que se evaluar√° la claridad de sus interpretaciones, la consistencia con los resultados del modelo y su capacidad para proponer acciones basadas en los hallazgos.
:::

